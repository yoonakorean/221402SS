<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>14-2 句子跟讀挑戰</title>
<style>
body { font-family: sans-serif; max-width: 600px; margin: auto; text-align: center; padding: 30px 15px; }
#logo { width: 150px; max-width: 80%; margin-bottom: 10px; }
#game-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
#question-number { font-size: 18px; margin-bottom: 10px; }
#question-selector { margin: 20px 0; }
button { padding: 10px 20px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; background-color: #f0f0f0; cursor: pointer; transition: background-color 0.3s; }
button:hover { background-color: #4a90e2; color: #fff; }
.selector-btn { width: 40px; height: 40px; margin: 5px; padding: 0; border-radius: 50%; }
.hidden { display: none; }
.audio-player-container { margin: 10px 0; }
audio { width: 100%; max-width: 500px; margin: 0 auto; display: block; }
.question-text { font-size: 20px; margin-bottom: 10px; font-weight: bold; }
.keywords { font-size: 20px; margin-bottom: 10px; }
#question-controls { margin-top: 20px; }
.record-btns { display: flex; justify-content: center; gap: 10px; margin: 10px 0; }
#progress-container { margin-top: 15px; font-size: 16px; }
#progress-bar { width: 100%; background-color: #eee; border-radius: 10px; overflow: hidden; height: 25px; margin-top: 5px; }
#progress-fill { height: 100%; width: 0%; background-color: #4a90e2; text-align: center; color: #fff; line-height: 25px; font-weight: bold; transition: width 0.3s; }
.completed { background-color: #4caf50; color: #fff; }
</style>
</head>
<body>
<img id="logo" src="logo.png" alt="Logo">
<div id="game-title">14-2 句子跟讀挑戰</div>

<div id="nickname-container">
  <div style="font-size:20px; font-weight:bold; margin-bottom:10px;">歡迎挑戰者到來</div>
  <div style="margin-bottom:10px;">請輸入您的姓名</div>
  <input type="text" id="nickname-input" placeholder="您的名字" style="padding:5px 10px; font-size:16px; width:80%; max-width:300px; margin-bottom:15px;">
  <br>
  <button id="start-game-btn">開始挑戰</button>
</div>

<div id="game-container" class="hidden">
  <div id="question-number">第 <span id="current-number">1</span> 題 / 共 10 題</div>
  <div id="question-selector"><strong>題目選擇：</strong></div>
  <div id="question-text" class="question-text"></div>
  <div class="practice-hint">進階練習：看著關鍵字，試著說出句子</div>
  <div id="keywords" class="keywords"></div>
  <button id="toggle-pro-mode">高手模式</button>
  <div class="pro-mode-hint">進入高手模式後 題目與關鍵字都會隱藏</div>
  <div id="question-controls">
    <div class="audio-player-container">
      <audio id="audio-player" controls></audio>
    </div>
    <div class="record-btns">
      <button id="start-btn">開始錄音</button>
      <button id="stop-btn" disabled>停止錄音</button>
    </div>
    <div class="user-audio-container">
      <audio id="user-audio" controls class="hidden"></audio>
      <button id="submit-audio-btn" class="hidden" style="margin-top:10px;">提交錄音</button>
    </div>
  </div>
  <div id="progress-container">
    已完成題目：<span id="completed-list">無</span>
    <div id="progress-bar">
      <div id="progress-fill">0%</div>
    </div>
    <div id="match-status" style="margin-top:10px; font-weight:bold; color:#4a90e2;"></div>
  </div>
</div>

<script src="recorder.js"></script>
<script>
const questions = [
{ audio: "audio/22140201S.mp3", text: "감기에 걸렸을 때는 이 약을 꼭 드세요.", keywords: "감기, 걸리다, 때, 약, 드시다" },
{ audio: "audio/22140202S.mp3", text: "처음 한국에 왔을 때는 모든 게 다 신기했어요.", keywords: "처음, 한국, 오다, 때, 신기하다" },
{ audio: "audio/22140203S.mp3", text: "한국은 첫 월급을 받았을 때 부모님께 내복을 선물하는 문화가 있어요.", keywords: "첫, 월급, 받다, 때, 부모님, 내복, 선물하다, 문화" },
{ audio: "audio/22140204S.mp3", text: "한국어 처음 배웠을 때 사용했던 노트와 책이에요.", keywords: "한국어, 처음, 배우다, 때, 사용하다, 노트, 책" },
{ audio: "audio/22140205S.mp3", text: "초등학생이었을 때는 여름 방학이 가장 기다려졌어.", keywords: "초등학생, 때, 여름, 방학, 기다리다" },
{ audio: "audio/22140206S.mp3", text: "학생이었을 때는 군인이 아저씨 같았는데 지금은 다 동생이에요.", keywords: "학생, 때, 군인, 아저씨, 같다, 지금, 동생" },
{ audio: "audio/22140207S.mp3", text: "부모님이 제 나이였을 때 저를 낳은 것이 믿기지 않아요.", keywords: "부모님, 나이, 때, 낳다, 믿기다" },
{ audio: "audio/22140208S.mp3", text: "친구 결혼식 갔을 때 아주 감동이었어.", keywords: "친구, 결혼식, 가다, 때, 감동" },
{ audio: "audio/22140209S.mp3", text: "미안해요. 저한테 전화했을 때 자고 있었어요.", keywords: "미안하다, 전화하다, 때, 자다" },
{ audio: "audio/22140210S.mp3", text: "이 가방 어렸을 때 제가 사용한 브랜드의 가방인 것 같아요!", keywords: "가방, 어리다, 때, 사용하다, 브랜드" }
];

let currentQuestion = 0;
let isProMode = false;
let recorder, audioContext, stream;
let startTime = Date.now();
let completedQuestions = [];

const unit = "22-14-2 句子跟讀挑戰";

const questionText = document.getElementById("question-text");
const keywordsDiv = document.getElementById("keywords");
const currentNumberSpan = document.getElementById("current-number");
const audioPlayer = document.getElementById("audio-player");
const userAudio = document.getElementById("user-audio");
const startBtn = document.getElementById("start-btn");
const stopBtn = document.getElementById("stop-btn");
const proModeBtn = document.getElementById("toggle-pro-mode");
const completedListSpan = document.getElementById("completed-list");
const progressFill = document.getElementById("progress-fill");
const submitBtn = document.getElementById("submit-audio-btn");
const matchStatus = document.getElementById("match-status");

const nicknameContainer = document.getElementById("nickname-container");
const nicknameInput = document.getElementById("nickname-input");
const startGameBtn = document.getElementById("start-game-btn");
const gameContainer = document.getElementById("game-container");

function showQuestion() {
  const q = questions[currentQuestion];
  questionText.textContent = q.text;
  keywordsDiv.textContent = `[${q.keywords}]`;
  currentNumberSpan.textContent = currentQuestion + 1;
  audioPlayer.src = q.audio;
  userAudio.classList.add("hidden");
  userAudio.src = "";
  submitBtn.classList.add("hidden");
  questionText.style.visibility = isProMode ? "hidden" : "visible";
  keywordsDiv.style.visibility = isProMode ? "hidden" : "visible";
  matchStatus.textContent = "";
}

function createQuestionButtons() {
  const selector = document.getElementById("question-selector");
  selector.innerHTML = "<strong>題目選擇：</strong>";
  questions.forEach((_, idx) => {
    const btn = document.createElement("button");
    btn.textContent = idx + 1;
    btn.className = "selector-btn";
    if (completedQuestions.includes(idx+1)) btn.classList.add("completed");
    btn.onclick = () => {
      stopRecordingIfNeeded();
      currentQuestion = idx;
      showQuestion();
    };
    selector.appendChild(btn);
  });
}

proModeBtn.onclick = () => {
  isProMode = !isProMode;
  questionText.style.visibility = isProMode ? "hidden" : "visible";
  keywordsDiv.style.visibility = isProMode ? "hidden" : "visible";
  proModeBtn.textContent = isProMode ? "恢復題目顯示" : "高手模式";
};

startBtn.onclick = async () => {
  stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const input = audioContext.createMediaStreamSource(stream);
  recorder = new Recorder(input, { numChannels: 1 });
  recorder.record();
  startBtn.disabled = true;
  stopBtn.disabled = false;

  questionText.style.visibility = "hidden";
};

stopBtn.onclick = () => {
  recorder.stop();
  stream.getAudioTracks()[0].stop();

  recorder.exportWAV(blob => {
    userAudio.src = URL.createObjectURL(blob);
    userAudio.classList.remove("hidden");
    submitBtn.classList.remove("hidden");
  });

  startBtn.disabled = false;
  stopBtn.disabled = true;
  if (!isProMode) questionText.style.visibility = "visible";
};

submitBtn.onclick = () => {
  const nickname = nicknameInput.value.trim() || "未輸入";
  const timeSpent = Math.floor((Date.now() - startTime)/1000);

  let dots = 0;
  matchStatus.textContent = "比對中";
  const interval = setInterval(() => {
    dots = (dots + 1) % 4;
    matchStatus.textContent = "比對中" + "·".repeat(dots);
  }, 500);

  submitBtn.classList.add("hidden");

  recognizeSpeech((recognizedText) => {
    clearInterval(interval);
    const target = questions[currentQuestion].text;
    const score = similarity(recognizedText, target);

    if (score >= 70) {
      matchStatus.textContent = `✅ 通過！相似度 ${score.toFixed(2)}%`;
      if (!completedQuestions.includes(currentQuestion+1)) {
        completedQuestions.push(currentQuestion+1);
        updateProgress();
        createQuestionButtons();
        const totalScore = (completedQuestions.length / questions.length) * 100;
        sendToGoogleForm(nickname, unit, totalScore, timeSpent, currentQuestion+1);
      }
    } else {
      matchStatus.textContent = `❌ 未通過，相似度 ${score.toFixed(2)}%，請重新錄音！`;
      userAudio.src = "";
      userAudio.classList.add("hidden");
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }
  });
};

function stopRecordingIfNeeded() {
  if (recorder && recorder.recording) {
    recorder.stop();
    stream.getAudioTracks()[0].stop();
    startBtn.disabled = false;
    stopBtn.disabled = true;
  }
}

function updateProgress() {
  completedListSpan.textContent = completedQuestions.length ? completedQuestions.join(",") : "無";
  const percent = ((completedQuestions.length / questions.length) * 100).toFixed(0);
  progressFill.style.width = percent + "%";
  progressFill.textContent = percent + "%";
}

function sendToGoogleForm(nickname, unit, score, time, questionNumber) {
  const formURL = "https://docs.google.com/forms/d/e/1FAIpQLSdESq5-zNmGUoR1QoQ-CJAQaroQfdNPKxOiSgeiJH4s_64DRg/formResponse";
  const formData = new FormData();
  formData.append("entry.1082970818", nickname);
  formData.append("entry.851626887", unit);
  formData.append("entry.498226528", score);
  formData.append("entry.532888754", time);
  formData.append("entry.1930371772", questionNumber);
  fetch(formURL, { method: "POST", body: formData, mode: "no-cors" })
    .then(() => console.log("已送出到 Google 表單！"))
    .catch(err => console.error("送出失敗：", err));
}

async function fetchPreviousProgress(nickname) {
  const apiUrl = "https://api.sheetbest.com/sheets/35939562-3d48-4fd0-9f49-689667e539f8";
  const apiKey = "w6rPgNCJ@o3#T#wNUqJr$Wlii53@IvANGznsOWETWo92i#LzHdvW3jj5OELq17-z";

  try {
    const response = await fetch(apiUrl, { headers: { Authorization: `Bearer ${apiKey}` } });
    const data = await response.json();

    const userRecords = data.filter(row => row.nickname === nickname && row.unit === unit);
    const completedSet = new Set();
    userRecords.forEach(row => {
      if (row.questionNumber) completedSet.add(parseInt(row.questionNumber));
    });

    completedQuestions = Array.from(completedSet).sort((a,b)=>a-b);
    updateProgress();

  } catch (err) {
    console.error("讀取先前進度失敗:", err);
  }
}

nicknameInput.onblur = () => {
  const name = nicknameInput.value.trim();
  if (name) fetchPreviousProgress(name);
};

startGameBtn.onclick = () => {
  if (!nicknameInput.value.trim()) {
    alert("請輸入您的姓名");
    return;
  }
  nicknameContainer.classList.add("hidden");
  gameContainer.classList.remove("hidden");
  startTime = Date.now();
  showQuestion();
  createQuestionButtons();
  updateProgress();
};

function similarity(a, b) {
  if (!a || !b) return 0;
  a = a.toLowerCase(); b = b.toLowerCase();
  let same = 0;
  const minLen = Math.min(a.length, b.length);
  for (let i=0;i<minLen;i++) if (a[i]===b[i]) same++;
  return (same / b.length) * 100;
}

function recognizeSpeech(callback) {
  setTimeout(() => {
    const random = Math.random();
    callback(random>0.5 ? questions[currentQuestion].text : "隨機錯誤結果");
  }, 2000);
}
</script>
</body>
</html>
